<!DOCTYPE html>
<html layout:decorate="~{layout}">

<head>
    <!-- Import map 설정 -->
    <script type='importmap'>
      {
        "imports": {
          "@fullcalendar/core": "https://cdn.skypack.dev/@fullcalendar/core@6.1.14",
          "@fullcalendar/daygrid": "https://cdn.skypack.dev/@fullcalendar/daygrid@6.1.14"
        }
      }
    </script>

    <!-- FullCalendar CSS -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.14/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.14/main.min.css" rel="stylesheet"> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.14/core/main.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.14/daygrid/main.min.css" rel="stylesheet">
</head>
<div layout:fragment="content" class="w-full my-3 flex justify-center items-center flex-col">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <div th:if="${#authentication.principal.authorities.iterator().next().authority == 'ROLE_TRAINER'}">
        <a class="btn btn-error text-white justify-start" th:href="@{/lesson/create}">추가</a>
    </div>
    <!-- FullCalendar 캘린더를 표시할 div 요소 -->
    <div id='calendar' class="mt-5 h-[500px] w-[550px] overflow-y-auto"></div>
    <div class="flex flex-col justify-center w-[80%] p-2">
        <div class="divider"></div>
        <div id="lessonListContainer"></div>
    </div>
    <script type='module'>
        import { Calendar } from '@fullcalendar/core';
        import dayGridPlugin from '@fullcalendar/daygrid';

        let calendarInstance; // 전역 변수로 캘린더 인스턴스를 선언합니다.
        let selectedDateElement = null; // 선택된 날짜를 저장할 변수

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarInstance = new Calendar(calendarEl, {
                plugins: [dayGridPlugin],
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                selectable: true,
                dayCellDidMount: function (info) {
                    info.el.addEventListener('click', function () {
                        // 클릭한 날짜 요소 가져오기
                        const clickedDateElement = info.el;
                        const clickedDate = calendarInstance.getDate(); // 클릭한 셀의 날짜 가져오기

                        // 이전에 선택된 날짜의 배경색 초기화
                        if (selectedDateElement) {
                            selectedDateElement.style.backgroundColor = ''; // 이전에 선택된 날짜의 배경색 초기화
                        }

                        // 선택한 날짜의 배경색 변경
                        clickedDateElement.style.backgroundColor = 'red'; // 원하는 배경색으로 변경

                        // 선택한 날짜를 변수에 저장
                        selectedDateElement = clickedDateElement;

                        // data-date 속성 값 가져오기
                        const dataDate = clickedDateElement.getAttribute('data-date');
                        sendDateToServer(dataDate);
                    });
                }
            });

            // 캘린더 렌더링
            calendarInstance.render();
        }

        // 선택한 날짜 데이터를 서버로 전송하는 함수
        function sendDateToServer(date) {
            // CSRF 토큰 요소를 가져옵니다
            const csrfTokenInput = document.querySelector('input[name="_csrf"]');
            const csrfParameterName = csrfTokenInput.getAttribute('name');

            // CSRF 토큰의 값
            const csrfToken = csrfTokenInput.value;

            // AJAX 요청 설정
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/lessonCalendar/selected-date", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            // CSRF 토큰 추가
            xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);

            // 요청 완료 후 처리
            xhr.onload = function () {
                let lessonList = [];
                if (xhr.status >= 200 && xhr.status < 300) {
                    // 성공적으로 요청이 처리됨
                    console.log('Date successfully sent to server.');
                    try {
                        // 서버에서 받은 JSON 데이터 처리
                        const responseData = JSON.parse(xhr.responseText);
                        console.log('Response from server:', responseData);

                        // responseData에 lessons라는 키가 있는 경우에만 lessonList에 할당
                        if (responseData.hasOwnProperty('lessons')) {
                            lessonList = responseData.lessons;

                            // lessonListContainer 초기화
                            const lessonListContainer = document.getElementById('lessonListContainer');
                            lessonListContainer.innerHTML = ''; // 기존 내용 초기화

                            // lessonList 반복 처리
                            lessonList.forEach(function (lesson) {
                                // 각 lesson에 대한 요소 생성
                                const lessonDiv = document.createElement('div');
                                lessonDiv.classList.add('flex', 'justify-center', 'items-center', 'h-[50px]', 'bg-base-100', 'mb-4', 'rounded-lg');

                                // 트레이너 이름
                                const trainerDiv = document.createElement('div');
                                trainerDiv.classList.add('h-full', 'bg-white', 'text-black', 'rounded-lg', 'border', 'border-gray-300', 'w-[10%]', 'flex', 'justify-center', 'items-center', 'font-bold');
                                const trainerName = document.createElement('div');
                                trainerName.textContent = `${lesson.trainer.name}`;
                                trainerDiv.appendChild(trainerName);

                                lessonDiv.appendChild(trainerDiv);

                                // 레슨 정보 표시 부분
                                const lessonInfoDiv = document.createElement('div');
                                lessonInfoDiv.classList.add('h-full', 'bg-white', 'rounded-lg', 'border', 'border-gray-300', 'w-[80%]', 'flex', 'text-black', 'justify-center', 'font-bold', 'items-center', 'mx-2');

                                const lessonNameDiv = document.createElement('div');
                                lessonNameDiv.textContent = lesson.lessonName;
                                lessonInfoDiv.appendChild(lessonNameDiv);

                                const startTimeDiv = document.createElement('div');
                                startTimeDiv.textContent = `start : ${lesson.startTime}`;
                                lessonInfoDiv.appendChild(startTimeDiv);

                                const endTimeDiv = document.createElement('div');
                                endTimeDiv.textContent = `end : ${lesson.endTime}`;
                                lessonInfoDiv.appendChild(endTimeDiv);

                                lessonDiv.appendChild(lessonInfoDiv);

                                // 인원 정보 표시 부분
                                const attendanceDiv = document.createElement('div');
                                attendanceDiv.classList.add('h-full', 'bg-white', 'text-black', 'rounded-lg', 'border', 'border-gray-300', 'w-[10%]', 'flex', 'justify-center', 'items-center');
                                const attendanceButton = document.createElement('button');
                                attendanceButton.classList.add('btn', 'w-full', 'h-full');
                                attendanceButton.textContent = `${lesson.attendanceList.length}/${lesson.headCount}`;

                                // 버튼 클릭 시 동작
                                attendanceButton.addEventListener('click', function () {
                                    const xhr = new XMLHttpRequest();
                                    xhr.open("POST", `/lesson/${lesson.id}/attend`, true);
                                    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

                                    // // CSRF 토큰 추가 (필요 시)
                                    // const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                                    

                                    // CSRF 토큰 설정
                                    const csrfTokenElement = document.getElementById('csrfToken');
                                    const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
                                    const csrfHeader = 'X-CSRF-TOKEN'; // Spring Security의 기본 CSRF 헤더 이름
                                    xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);

                                    xhr.onload = function () {
                                        if (xhr.status >= 200 && xhr.status < 300) {
                                            const responseData = JSON.parse(xhr.responseText);
                                            console.log('Response from server:', responseData);
                                            // 여기서 attendanceList의 사이즈를 체크하고 동작을 수행할 수 있음
                                        } else {
                                            console.error('Failed to attend lesson:', xhr.statusText);
                                        }
                                    };

                                    xhr.send();
                                });

                                attendanceDiv.appendChild(attendanceButton);
                                lessonDiv.appendChild(attendanceDiv);

                                lessonListContainer.appendChild(lessonDiv);
                            });
                        } else {
                            console.error('Invalid response format: lessons not found');
                        }
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                    }
                } else {
                    // 요청이 실패한 경우
                    console.error('Failed to send date to server.');
                }
            };
            // 네트워크 오류 처리
            xhr.onerror = function () {
                console.error('Network error occurred.');
            };

            // 요청 보내기
            const requestData = JSON.stringify({ date: date });
            xhr.send(requestData);
        }

        // DOMContentLoaded 이벤트가 발생하면 initializeCalendar 함수를 호출
        document.addEventListener('DOMContentLoaded', function () {
            initializeCalendar();

            // CSRF 토큰 설정
            const csrfTokenElement = document.getElementById('csrfToken');
            const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
            const csrfHeader = 'X-CSRF-TOKEN'; // Spring Security의 기본 CSRF 헤더 이름
        });
    </script>

</div>

</html>