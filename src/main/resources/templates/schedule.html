<!DOCTYPE html>
<html layout:decorate="~{layout}">

<head>
    <!-- Import map 설정 -->
    <script type='importmap'>
      {
        "imports": {
          "@fullcalendar/core": "https://cdn.skypack.dev/@fullcalendar/core@6.1.14",
          "@fullcalendar/daygrid": "https://cdn.skypack.dev/@fullcalendar/daygrid@6.1.14"
        }
      }
    </script>

    <!-- FullCalendar CSS -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.14/main.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.14/main.min.css" rel="stylesheet"> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.14/core/main.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.14/daygrid/main.min.css" rel="stylesheet">
</head>
<div layout:fragment="content" class="w-full my-3 flex justify-center items-center flex-col">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <div th:if="${#authentication.principal.authorities.iterator().next().authority == 'ROLE_TRAINER'}">
        <a class="btn btn-error text-white justify-start" th:href="@{/lesson/create}">추가</a>
    </div>
    <!-- FullCalendar 캘린더를 표시할 div 요소 -->
    <div id='calendar' class="mt-5 h-[500px] w-[550px] overflow-y-auto"></div>
    <div class="flex flex-col justify-center w-[80%] p-2">
        <div class="divider"></div>
        <div id="lessonListContainer"></div>
    </div>
    <script type='module'>
        import { Calendar } from '@fullcalendar/core';
        import dayGridPlugin from '@fullcalendar/daygrid';

        let calendarInstance; // 전역 변수로 캘린더 인스턴스를 선언합니다.
        let selectedDateElement = null; // 선택된 날짜를 저장할 변수

        // 날짜 선택 함수
        // CSRF 토큰을 가져오는 함수
        function getCsrfToken() {
            const csrfTokenInput = document.querySelector('input[name="_csrf"]');
            return csrfTokenInput ? csrfTokenInput.value : '';
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarInstance = new Calendar(calendarEl, {
                plugins: [dayGridPlugin],
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                selectable: true,
                dayCellDidMount: function (info) {
                    info.el.addEventListener('click', function () {
                        const clickedDateElement = info.el;
                        const clickedDate = calendarInstance.getDate();

                        if (selectedDateElement) {
                            selectedDateElement.style.backgroundColor = '';
                        }

                        clickedDateElement.style.backgroundColor = 'red';
                        selectedDateElement = clickedDateElement;

                        const dataDate = clickedDateElement.getAttribute('data-date');
                        sendDateToServer(dataDate);
                    });
                }
            });
            calendarInstance.render();
        }

        function sendDateToServer(date) {
            const csrfToken = getCsrfToken();

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/lessonCalendar/selected-date", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);

            xhr.onload = function () {
                let lessonList = [];
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const responseData = JSON.parse(xhr.responseText);
                        if (responseData.hasOwnProperty('lessons')) {
                            lessonList = responseData.lessons;
                            const lessonListContainer = document.getElementById('lessonListContainer');
                            lessonListContainer.innerHTML = '';

                            lessonList.forEach(function (lesson) {
                                const lessonDiv = document.createElement('div');
                                lessonDiv.classList.add('flex', 'justify-center', 'items-center', 'h-[50px]', 'bg-base-100', 'mb-4', 'rounded-lg');

                                const trainerDiv = document.createElement('div');
                                trainerDiv.classList.add('h-full', 'bg-white', 'text-black', 'rounded-lg', 'border', 'border-gray-300', 'w-[10%]', 'flex', 'justify-center', 'items-center', 'font-bold');
                                const trainerName = document.createElement('div');
                                trainerName.textContent = `${lesson.trainer.name}`;
                                trainerDiv.appendChild(trainerName);

                                lessonDiv.appendChild(trainerDiv);

                                const lessonInfoDiv = document.createElement('div');
                                lessonInfoDiv.classList.add('h-full', 'bg-white', 'rounded-lg', 'border', 'border-gray-300', 'w-[80%]', 'flex', 'text-black', 'justify-center', 'font-bold', 'items-center', 'mx-2');
                                const lessonNameDiv = document.createElement('div');
                                lessonNameDiv.textContent = lesson.lessonName;
                                lessonInfoDiv.appendChild(lessonNameDiv);

                                const startTimeDiv = document.createElement('div');
                                startTimeDiv.textContent = `start : ${lesson.startTime}`;
                                lessonInfoDiv.appendChild(startTimeDiv);

                                const endTimeDiv = document.createElement('div');
                                endTimeDiv.textContent = `end : ${lesson.endTime}`;
                                lessonInfoDiv.appendChild(endTimeDiv);

                                lessonDiv.appendChild(lessonInfoDiv);

                                const attendanceDiv = document.createElement('div');
                                attendanceDiv.classList.add('h-full', 'bg-white', 'text-black', 'rounded-lg', 'border', 'border-gray-300', 'w-[10%]', 'flex', 'justify-center', 'items-center');
                                const attendanceButton = document.createElement('button');
                                attendanceButton.classList.add('btn', 'w-full', 'h-full');
                                attendanceButton.textContent = `${lesson.attendanceList.length}/${lesson.headCount}`;

                                // 현재 로그인된 사용자가 attendanceList에 있는지 확인
                                const isAttending = lesson.attendanceList.some(attendee => attendee.username === currentUser);

                                if (isAttending) {
                                    attendanceButton.classList.add('bg-green-500', 'text-white');
                                    attendanceButton.innerHTML = `예약완료 <br> ${lesson.attendanceList.length}/${lesson.headCount}`;
                                } else {
                                    attendanceButton.classList.add('bg-red-500', 'text-white');
                                    attendanceButton.innerHTML = `예약하기 <br> ${lesson.attendanceList.length}/${lesson.headCount}`;
                                }

                                attendanceButton.addEventListener('click', function () {
                                    window.location.href = `/lesson/detail/${lesson.id}`;
                                });


                                attendanceDiv.appendChild(attendanceButton);
                                lessonDiv.appendChild(attendanceDiv);

                                lessonListContainer.appendChild(lessonDiv);
                            });
                        } else {
                            console.error('Invalid response format: lessons not found');
                        }
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                    }
                } else {
                    console.error('Failed to send date to server.');
                }
            };
            xhr.onerror = function () {
                console.error('Network error occurred.');
            };

            const requestData = JSON.stringify({ date: date });
            xhr.send(requestData);
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeCalendar();
        });
    </script>
</div>

</html>