<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container-fluid my-3 flex justify-center">
    <span th:text="${#authentication.principal.authorities.iterator().next().authority}"></span>
    <div class="row my-3 h-[10%]">
        <a class="btn btn-ghost text-xs" th:href="@{|/homeTraining/home|}">전체</a>
        <div th:each="category : ${categoryList}">
            <a class="btn btn-ghost text-xs" th:href="@{|/homeTraining/home?categoryId=${category.id}|}"
               th:text="${category.name}"></a>
        </div>
<!--        <a th:if="${#authorization.expression('isAuthenticated()')}" th:href="@{|/category/create|}"-->
<!--           class="btn btn-primary">카테고리 추가</a>-->
        <div th:if="${#authentication.principal.authorities.iterator().next().authority == 'ROLE_ADMIN'}">
            <a th:href="@{|/category/create|}"
               class="btn btn-primary">카테고리 추가</a>
            <a class="btn btn-error text-white justify-start" th:href="@{/homeTraining/create}">추가</a>
        </div>
    </div>
    <div class="flex w-full">
        <div class="card w-96 bg-base-100 shadow-xl m-4 block" th:each="homeTraining:${homeTrainingList}">
            <div class="text-black">
                <div th:if="${#authentication.principal.authorities.iterator().next().authority == 'ROLE_ADMIN'}">
                    <a href="javascript:void(0);" th:data-uri="@{|/homeTraining/delete/${homeTraining.id}|}"
                       class="delete btn btn-error my-2" th:text="삭제"></a>
                    <a th:href="@{|/homeTraining/update/${homeTraining.id}|}" class="btn btn-primary my-2">수정</a>
                </div>
                <a th:href="${homeTraining.videoUrl}">
                    <img th:src="${homeTraining.thumbnailUrl}" alt="video">
                </a>
            </div>
            <div class="flex">
                <a href="#" class="recommend w-[10%] h-[100%] btn btn-sm btn-outline-secondary"
                    onclick="toggleBookmark(event)">
                    <i class="fa-regular fa-bookmark"></i>
                    <div class="hidden" th:data-ht-id="${homeTraining.id}"></div>
                </a>
                <span class="btn w-[65%] text-black" th:text="${homeTraining.content}"></span>
                <div class="d-flex justify-content-end w-[25%]">
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">
                            <span th:if="${homeTraining.writer != null}" th:text="${homeTraining.writer.name}"></span>
                            <div th:text="${#temporals.format(homeTraining.createDate, 'yyyy-MM-dd')}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const delete_elements = document.getElementsByClassName("delete");
        Array.from(delete_elements).forEach(function(element) {
            element.addEventListener('click', function() {
                if(confirm("정말로 삭제하시겠습니까?")) {
                    location.href = this.dataset.uri;
                };
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            updateInitialIconState();
        });

        function updateInitialIconState() {
            const bookmarks = document.querySelectorAll('.recommend');
            bookmarks.forEach(bookmark => {
                const icon = bookmark.querySelector('i');
                const hiddenDiv = bookmark.querySelector('.hidden');
                const htId = hiddenDiv.getAttribute('data-ht-id');

                fetch(`/homeTraining/bookmark/${htId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.bookmarked) {
                            icon.classList.remove('fa-regular');
                            icon.classList.add('fa-solid');
                        } else {
                            icon.classList.remove('fa-solid');
                            icon.classList.add('fa-regular');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });
        }

        function toggleBookmark(event) {
            event.preventDefault(); // 링크의 기본 동작을 방지
            const icon = event.currentTarget.querySelector('i');
            const isBookmarked = icon.classList.contains('fa-solid');
            const hiddenDiv = event.currentTarget.querySelector('.hidden');
            const htId = hiddenDiv.getAttribute('data-ht-id');

            fetch('/homeTraining/bookmark', {
                method: isBookmarked ? 'DELETE' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value // CSRF 토큰 필요시
                },
                body: JSON.stringify({ htId: htId }) // `htId`를 JSON으로 전달
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (isBookmarked) {
                            icon.classList.remove('fa-solid', 'fa-bookmark');
                            icon.classList.add('fa-regular', 'fa-bookmark');
                        } else {
                            icon.classList.remove('fa-regular', 'fa-bookmark');
                            icon.classList.add('fa-solid', 'fa-bookmark');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    </script>
</div>

</html>